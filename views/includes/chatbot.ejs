<link rel="stylesheet" href="/css/chatbot.css">

<!-- Floating Chat Button -->
<button id="open-chat" class="open-chat-btn">Chat</button>

<!-- Chat Sidebar -->
<div class="sidebar" id="chat-sidebar">
  <div class="chat-header">
    <span>AI Study Assistant</span>
    <button id="close-btn">&times;</button>
  </div>

  <div class="chat-messages" id="chat-container">
    <div class="text-center text-muted">
      <p>Ask me anything about your studies!</p>
    </div>
  </div>

  <form id="chat-form" class="chat-input">
    <input type="text" id="message-input" placeholder="Type your question here..." required />
    <button type="submit">Send</button>
  </form>
</div>


<script>
/* --- Sidebar toggle --- */
const openBtn = document.getElementById('open-chat');
const closeBtn = document.getElementById('close-btn');
const sidebar = document.getElementById('chat-sidebar');

openBtn.addEventListener('click', () => {
  sidebar.classList.add('active');
  openBtn.classList.add('hide-btn'); // hide the button
});

closeBtn.addEventListener('click', () => {
  sidebar.classList.remove('active');
  openBtn.classList.remove('hide-btn'); // show the button
});

/* --- Chat functionality --- */
document.getElementById('chat-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const messageInput = document.getElementById('message-input');
  const message = messageInput.value.trim();
  if (!message) return;
  
  // Add user message
  addMessageToChat('user', message);
  messageInput.value = '';
  
  // Show loading
  const loadingId = addMessageToChat('assistant', 'Thinking...', true);
  
  try {
    const response = await fetch('/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message })
    });
    
    const data = await response.json();
    
    removeMessage(loadingId);
    addMessageToChat('assistant', data.reply);
  } catch (error) {
    removeMessage(loadingId);
    addMessageToChat('assistant', 'Sorry, I encountered an error. Please try again.');
  }
});

/* --- Helper functions --- */
function addMessageToChat(sender, message, isLoading = false) {
  const chatContainer = document.getElementById('chat-container');
  const messageId = 'msg-' + Date.now();
  
  const messageDiv = document.createElement('div');
  messageDiv.id = messageId;
  messageDiv.className = `mb-3 ${sender === 'user' ? 'text-end user-message' : 'text-start bot-message'}`;
  
  const messageContent = document.createElement('div');
  messageContent.className = `d-inline-block p-3 rounded ${sender === 'user' ? 'bg-primary text-white' : 'bg-light text-dark'}`;
  messageContent.style.maxWidth = '80%';
  
  messageContent.innerHTML = isLoading 
      ? '<div class="spinner-border spinner-border-sm me-2" role="status"></div>' + message
      : message;
  
  messageDiv.appendChild(messageContent);
  chatContainer.appendChild(messageDiv);
  
  chatContainer.scrollTop = chatContainer.scrollHeight; // scroll to bottom
  return messageId;
}

function removeMessage(messageId) {
  const msg = document.getElementById(messageId);
  if (msg) msg.remove();
}
</script>
